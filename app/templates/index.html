{% extends "base.html" %}

{% block title %}ParkUPB - HartÄƒ ParcÄƒri{% endblock %}

{% block content %}
<div class="app-container">
    <div class="map-section">
        <div id="map" class="map-container">
            <div class="map-placeholder">
                <div class="placeholder-content">
                    <h2>Harta ParcÄƒrilor UPB</h2>
                    <p>Harta va fi afiÈ™atÄƒ aici</p>
                    <!-- <small>Task 7: Implementare hartÄƒ Leaflet</small> -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Section (Right side - info panel) -->
    <aside class="sidebar">
        <!-- User Info Section - aratÄƒ doar dacÄƒ e logat -->
        {% if current_user.is_authenticated %}
        <section class="sidebar-section">
            <div class="section-header">
                <h3>Cont utilizator</h3>
            </div>
            <div class="section-content">
                <div class="user-info-card">
                    <p><strong>{{ current_user.full_name }}</strong></p>
                    <p class="text-muted">{{ current_user.email }}</p>
                    <p class="user-role"><span class="badge badge-primary">{{ current_user.role }}</span></p>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- Filters Section -->
        <section class="sidebar-section">
            <div class="section-header">
                <h3>Filtre</h3>
            </div>
            <div class="section-content">
                <div class="filter-group">
                    <label for="filter-parking-lot" class="form-label">Parcare:</label>
                    <select id="filter-parking-lot" class="form-control" onchange="applyFilters()">
                        <option value="">Toate parcÄƒrile</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-status" class="form-label">Status:</label>
                    <select id="filter-status" class="form-control" onchange="applyFilters()">
                        <option value="">Toate locurile</option>
                        <option value="free">ðŸŸ¢ Libere</option>
                        <option value="occupied">ðŸ”´ Ocupate</option>
                        <option value="reserved">ðŸŸ¡ Rezervate</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary btn-block" onclick="resetFilters()">
                    â†º ReseteazÄƒ filtre
                </button>
                
                <div class="filter-stats">
                    <small id="spots-count">Locuri afiÈ™ate: 0</small>
                </div>
            </div>
        </section>

        <!-- Parking Lot Stats Section -->
        <section class="sidebar-section" id="stats-section">
            <div class="section-header">
                <h3>Statistici parcare</h3>
            </div>
            <div class="section-content">
                <div id="stats-title" class="text-muted">SelecteazÄƒ o parcare</div>

                <div class="filter-group" style="margin-top:10px;">
                    <label for="stats-hour" class="form-label">Ora analizatÄƒ:</label>
                    <select id="stats-hour" class="form-control" onchange="refreshStats()">
                        <option value="">ToatÄƒ ziua (distribuÈ›ie)</option>
                        <option value="8">08:00</option>
                        <option value="9">09:00</option>
                        <option value="10">10:00</option>
                        <option value="11">11:00</option>
                        <option value="12">12:00</option>
                        <option value="13">13:00</option>
                        <option value="14">14:00</option>
                        <option value="15">15:00</option>
                        <option value="16">16:00</option>
                        <option value="17">17:00</option>
                        <option value="18">18:00</option>
                        <option value="19">19:00</option>
                        <option value="20">20:00</option>
                    </select>
                    <small class="text-muted">Probabilitatea este calculatÄƒ din ultimele 7 zile.</small>
                    </div>

                    <div class="stat-card" style="margin-top:10px;">
                    <div class="stat-label">Probabilitate ocupat la ora selectatÄƒ</div>
                    <div class="stat-value" id="stat-hour-prob">â€”</div>
                    </div>

                    <!-- opÈ›ional: mini chart pe ore -->
                    <div id="hourly-mini-chart" style="margin-top:10px;"></div>

                <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Total</div><div class="stat-value" id="stat-total">-</div></div>
                <div class="stat-card"><div class="stat-label">Libere</div><div class="stat-value" id="stat-free">-</div></div>
                <div class="stat-card"><div class="stat-label">Ocupate</div><div class="stat-value" id="stat-occupied">-</div></div>
                <div class="stat-card"><div class="stat-label">Rezervate</div><div class="stat-value" id="stat-reserved">-</div></div>
                </div>

                <div class="availability">
                <div class="availability-row">
                    <span>Disponibilitate</span>
                    <strong id="stat-availability">-</strong>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="availability-bar" style="width:0%"></div>
                </div>
                <small class="text-muted" id="stats-updated">â€”</small>
                </div>
            </div>
        </section>

        <!-- Current Reservation Section -->
        <section class="sidebar-section">
            <div class="section-header">
                <h3>Rezervarea curentÄƒ</h3>
            </div>
            <div class="section-content" id="current-reservation-content">
                <!-- TODO: Task 9 - Reservation logic -->
                <div class="no-reservation">
                    <p>Nu existÄƒ nicio rezervare activÄƒ</p>
                </div>
            </div>
        </section>

        <!-- Past Reservations Section -->
        <section class="sidebar-section">
            <div class="section-header">
                <h3>Istoric rezervÄƒri</h3>
            </div>
            <div class="section-content" id="reservation-history-content">
                <!-- TODO: Task 10 - Past reservations -->
                <div class="empty-state">
                    <p>Nu existÄƒ rezervÄƒri anterioare</p>
                </div>
            </div>
        </section>
    </aside>
</div>

<div id="reservation-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999;">
  <div style="max-width:420px; margin:10vh auto; background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25);">
    <h3 style="margin:0 0 10px 0;">RezervÄƒ loc</h3>

    <div style="display:flex; flex-direction:column; gap:10px;">
      <label>
        <div style="font-size:13px; margin-bottom:4px;">Start</div>
        <input id="reserve-start" type="datetime-local" class="form-control">
      </label>

      <label>
        <div style="font-size:13px; margin-bottom:4px;">End</div>
        <input id="reserve-end" type="datetime-local" class="form-control">
      </label>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button class="btn btn-secondary btn-sm" onclick="closeReservationModal()">RenunÈ›Äƒ</button>
      <button class="btn btn-primary btn-sm" onclick="submitReservationModal()">ConfirmÄƒ</button>
    </div>

    <div id="reservation-modal-hint" style="margin-top:10px; font-size:12px; color:#666;"></div>
  </div>
</div>

<div id="toast-container" style="position:fixed; top:16px; left:50%; transform:translateX(-50%); z-index:10000; display:flex; flex-direction:column; gap:10px; align-items:center; pointer-events:none;"></div>


{% endblock %}

{% block scripts %}
<script id="current-user-json" type="application/json">
{{ {
  "isAuthenticated": current_user.is_authenticated,
  "email": (current_user.email if current_user.is_authenticated else None),
  "role": (current_user.role if current_user.is_authenticated else None)
} | tojson }}
</script>

<script>
  window.CURRENT_USER = JSON.parse(document.getElementById('current-user-json').textContent);
</script>

<!-- Leaflet Routing Machine -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/auth.js') }}"></script>

{% endblock %}